parameters:
  serviceName: ''
  databaseName: ''
  location: ''
  loggingLevel: ''
  tmpFolder: 'C:\Users\VssAdministrator\AppData\Local\Temp'
  sqlArtifactFolder: '$(Pipeline.Workspace)/package_build/sqlMigrations'

steps:

- ${{ if eq(parameters.loggingLevel, 'Debug') }}:
  - task: CmdLine@2
    displayName: "[Debug] Output artifact structure"
    inputs:
      script: 'ls -R ${{parameters.sqlArtifactFolder}}'

# Run initial SQL script
- task: AzureKeyVault@2
  displayName: Get Credentials for Db script
  inputs:
    azureSubscription: '${{parameters.serviceName}}'
    KeyVaultName: '${{parameters.keyVaultName}}'    
    SecretsFilter: 'CarsApiSQLAdminUsername,CarsApiSQLAdminPassword'
    RunAsPreJob: false

- ${{ if eq(parameters.loggingLevel, 'Debug') }}:
  - task: CmdLine@2
    displayName: "[Debug] Output tmp folder"
    inputs:
      script: |
        ls -R ${{parameters.tmpFolder}}
        cat ${{parameters.tmpFolder}}/T*.tmp

- task: SqlAzureDacpacDeployment@1
  displayName: Run initial Sql sheet
  inputs:
    TaskType: 'sqlQuery'
    SqlFile: '${{parameters.sqlArtifactFolder}}/initial.sql'
    ExecuteInTransaction: true
    ServerName: '$(AppOutputs.sqlServerName.value)'
    DatabaseName: '${{parameters.databaseName}}'
    AuthScheme: 'sqlServerAuthentication'
    SqlUsername: '$(CarsApiSQLAdminUsername)'
    SqlPassword: '$(CarsApiSQLAdminPassword)'